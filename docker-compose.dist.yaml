x-shared-logs: &shared-logs
  logging:
    driver: "json-file"
    options:
      max-size: "10k"

services:

  observer:
    image: coddy-bot:latest
    build:
      context: .
    container_name: coddy-observer
    restart: unless-stopped
    secrets:
      - github_token
      - webhook_secret
    environment:
      GITHUB_TOKEN_FILE: /run/secrets/github_token
      WEBHOOK_SECRET_FILE: /run/secrets/webhook_secret
      BOT_REPOSITORY: "EvilFreelancer/coddy"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ${REPO_PATH:-.}:/app/workspace:rw
    ports:
      - "${CODDY_PORT:-8000}:8000"
    command: ["python", "-m", "coddy", "observer", "--config", "/app/config.yaml"]
    <<: *shared-logs

  worker:
    image: coddy-bot:latest
    build:
      context: .
    container_name: coddy-worker
    restart: unless-stopped
    secrets:
      - github_token
      - cursor_agent_token
    environment:
      GITHUB_TOKEN_FILE: /run/secrets/github_token
      CURSOR_AGENT_TOKEN_FILE: /run/secrets/cursor_agent_token
      BOT_REPOSITORY: "EvilFreelancer/coddy"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ${REPO_PATH:-.}:/app/workspace:rw
    command: ["python", "-m", "coddy", "worker", "--config", "/app/config.yaml"]
    <<: *shared-logs

secrets:
  github_token:
    file: ./.secrets/github_token
  webhook_secret:
    file: ./.secrets/webhook_secret
  cursor_agent_token:
    file: ./.secrets/cursor_agent_token
