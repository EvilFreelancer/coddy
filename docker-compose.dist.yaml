services:
  coddy-daemon:
    build: .
    image: coddy-bot:latest
    container_name: coddy-daemon
    restart: unless-stopped
    secrets:
      - github_token
      - webhook_secret
      - cursor_agent_token
    environment:
      GITHUB_TOKEN_FILE: /run/secrets/github_token
      WEBHOOK_SECRET_FILE: /run/secrets/webhook_secret
      CURSOR_AGENT_TOKEN_FILE: /run/secrets/cursor_agent_token
      BOT_REPOSITORY: "EvilFreelancer/coddy"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ${REPO_PATH:-.}:/app/workspace:rw
    ports:
      - "${CODDY_PORT:-8000}:8000"
    command: ["python", "-m", "coddy.main", "daemon", "--config", "/app/config.yaml"]

  coddy-worker:
    image: coddy-bot:latest
    container_name: coddy-worker
    restart: unless-stopped
    depends_on:
      - coddy-daemon
    secrets:
      - github_token
      - webhook_secret
      - cursor_agent_token
    environment:
      GITHUB_TOKEN_FILE: /run/secrets/github_token
      WEBHOOK_SECRET_FILE: /run/secrets/webhook_secret
      CURSOR_AGENT_TOKEN_FILE: /run/secrets/cursor_agent_token
      BOT_REPOSITORY: "EvilFreelancer/coddy"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ${REPO_PATH:-.}:/app/workspace:rw
    command: ["python", "-m", "coddy.main", "worker", "--config", "/app/config.yaml"]

secrets:
  github_token:
    file: ./.secrets/github_token
  webhook_secret:
    file: ./.secrets/webhook_secret
  cursor_agent_token:
    file: ./.secrets/cursor_agent_token
